<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>복합운동 | SMILE FIT</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=SUIT:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            opacity: 0;
            transition: opacity 0.4s ease;
            margin: 0;
            font-family: 'SUIT', sans-serif;
            background-color: white;
            color: #333;
            text-align: center;
        }

        body.loaded {
            opacity: 1;
        }

        body.fade-out {
            opacity: 0;
        }

        header {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(90deg, #69b7ff, #a17fff);
            padding: 30px;
            font-size: 28px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .home-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
            padding: 10px 20px;
            background: #ff4081;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            box-shadow: 0 0 10px #ff4081;
        }

        .home-button:hover {
            background: #e91e63;
            box-shadow: 0 0 15px #ff4081;
        }

        .main-content {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 60px;
            padding: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .image-box, .camera-box {
            position: relative;
        }

        /* video 태그에 직접 스타일 적용 */
        .camera-box video, .image-box img, canvas { 
            width: 320px;
            height: 240px;
            border-radius: 10px;
            border: 2px solid #ccc;
        }

        .round-text {
            font-size: 30px;
            font-weight: bold;
            margin: 25px 0 15px;
        }
        
        #submit-btn {
            margin-top: 20px;
            padding: 12px 28px;
            font-size: 16px;
            font-weight: bold;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        #submit-btn:hover {
            background-color: #43a047;
        }

        #check-mark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: #4CAF50;
            display: none;
            animation: fade 1s ease forwards;
            z-index: 1000;
        }

        @keyframes fade {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>

    <header>SMILE FIT</header>
    <a href="{{ url_for('index') }}" class="home-button">HOME</a>

    <div class="round-text">ROUND <span id="display-current-round">1</span> / <span id="display-total-rounds">8</span> (SET <span id="display-current-set">1</span> / <span id="display-total-sets">2</span>)</div>
    <div class="main-content">
        <div class="image-box">
            <img id="reference-img" src="" alt="기준 이미지">
        </div>
        <div class="camera-box">
            <video id="video-element" width="320" height="240" autoplay playsinline></video>
            <canvas id="guide-canvas" width="320" height="240" style="position: absolute; top: 0; left: 0;"></canvas>
        </div>
    </div>

    <button id="submit-btn">사진 제출</button>

    <div id="check-mark">✅</div>

    <script>
        // const videoFeedElement = document.getElementById('video-feed'); // 기존 img 태그 참조 제거
        const videoElement = document.getElementById('video-element'); // 새로 추가된 video 태그 참조
        const guideCanvas = document.getElementById('guide-canvas');
        const guideCtx = guideCanvas.getContext('2d');
        const referenceImg = document.getElementById('reference-img');
        const submitBtn = document.getElementById('submit-btn');
        const checkMark = document.getElementById('check-mark');

        const displayCurrentRound = document.getElementById('display-current-round');
        const displayTotalRounds = document.getElementById('display-total-rounds');
        const displayCurrentSet = document.getElementById('display-current-set');
        const displayTotalSets = document.getElementById('display-total-sets');

        // 운동 설정 (총 8라운드, 2세트, 세트당 4라운드)
        const TOTAL_ROUNDS_PER_SET = 4; // 각 세트당 라운드 수
        const TOTAL_SETS = 2;          // 총 세트 수
        const OVERALL_TOTAL_ROUNDS = TOTAL_ROUNDS_PER_SET * TOTAL_SETS; // 전체 라운드 수 (8)

        // URL 파라미터에서 현재 세트 번호 받아오기 (Flask에서 전달받음)
        const urlParams = new URLSearchParams(window.location.search);
        let currentSet = parseInt(urlParams.get('current_set') || '1'); 
        let currentRoundInSet = 1; // 세트 내 라운드는 항상 1부터 시작 (각 세트 시작 시 1로 리셋)
        
        // 전체 완료된 라운드 초기화 (현재 세트가 몇 번째 라운드부터 시작해야 하는지 계산)
        let totalCompletedRounds = (currentSet - 1) * TOTAL_ROUNDS_PER_SET;

        // 서버에서 전달받은 선생님 ID
        const teacher = "{{ teacher }}"; 

        if (!teacher) {
            alert("선생님 정보가 없습니다. 이전 페이지에서 다시 선택해주세요.");
            window.location.href = "{{ url_for('complex') }}";
        }

        // --- 웹캠 스트림 시작 함수 (새로 추가) ---
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
                // 비디오 스트림이 로드되면 캔버스 크기 조정
                videoElement.onloadedmetadata = () => {
                    // 비디오 엘리먼트의 실제 해상도를 캔버스에 적용
                    guideCanvas.width = videoElement.videoWidth;
                    guideCanvas.height = videoElement.videoHeight;
                    // 웹캠이 로드된 후에 비디오 요소를 재생하여 스트림이 시작되도록 보장
                    videoElement.play(); 
                };
                videoElement.onerror = (e) => { // 비디오 재생 중 오류 처리
                    console.error("비디오 엘리먼트 오류:", e);
                    alert("비디오 스트림 재생 중 오류가 발생했습니다. 브라우저 콘솔을 확인해주세요.");
                };
            } catch (err) {
                console.error("웹캠 접근 오류:", err);
                alert("웹캠을 켜는 데 문제가 발생했습니다. 권한을 확인하거나 다른 프로그램에서 사용 중인 웹캠을 닫아주세요.");
            }
        }

        // 타원 가이드 그리기 (기존 로직 유지)
        function drawEllipse() {
            guideCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
            // 비디오 엘리먼트가 준비되었을 때만 가이드를 그립니다.
            if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                 // 비디오 위에 랜드마크를 그리는 코드가 여기에 있을 수 있음
                 // (예: MediaPipe JS 버전에서 랜드마크를 받아 그리는 로직)
            }
            guideCtx.beginPath();
            guideCtx.ellipse(guideCanvas.width / 2, guideCanvas.height / 2, 80, 100, 0, 0, 2 * Math.PI);
            guideCtx.strokeStyle = 'rgba(0, 255, 0, 0.4)';
            guideCtx.lineWidth = 3;
            guideCtx.stroke();
        }
        // setInterval(drawEllipse, 100); // 비디오 스트림이 없어져도 가이드는 계속 그려질 수 있으므로, 웹캠 시작 후 또는 비디오가 있을 때만 호출하는 것이 좋습니다.

        // 라운드 이미지 및 텍스트 업데이트
        function updateDisplay() {
            const imageIndex = ((currentSet - 1) * TOTAL_ROUNDS_PER_SET) + currentRoundInSet;
            const actualImageNumber = imageIndex; 

            referenceImg.src = `/static/images/teachers/${teacher}/${teacher}${actualImageNumber}.png`;
            
            displayCurrentRound.textContent = totalCompletedRounds + currentRoundInSet; 
            displayTotalRounds.textContent = OVERALL_TOTAL_ROUNDS;
            displayCurrentSet.textContent = currentSet;
            displayTotalSets.textContent = TOTAL_SETS;
        }

        // --- "사진 제출" 버튼 클릭 이벤트 ---
        submitBtn.onclick = async () => {
            // 웹캠 스트림이 준비되지 않았다면 경고
            if (!videoElement.srcObject || videoElement.readyState !== videoElement.HAVE_ENOUGH_DATA) { 
                alert('웹캠 영상이 아직 준비되지 않았습니다. 잠시 기다려주세요.');
                return;
            }

            submitBtn.disabled = true; // 버튼 중복 클릭 방지
            checkMark.style.display = 'block'; 
            setTimeout(() => {
                checkMark.style.display = 'none'; 
            }, 800); // 체크마크 표시 시간 0.8초로 설정

            // --- 웹캠 프레임 캡처 ---
            const captureCanvas = document.createElement('canvas'); // 캡처용 캔버스
            captureCanvas.width = videoElement.videoWidth;
            captureCanvas.height = videoElement.videoHeight;
            const captureCtx = captureCanvas.getContext('2d');

            // <video> 태그의 현재 프레임을 캔버스에 그리기
            captureCtx.drawImage(videoElement, 0, 0, captureCanvas.width, captureCanvas.height);
            
            // 캡처된 이미지를 Blob으로 변환
            captureCanvas.toBlob(async (blob) => {
                if (!blob) {
                    alert('이미지 캡처에 실패했습니다.');
                    console.error('Canvas to Blob failed. Blob is null.');
                    submitBtn.disabled = false; // 실패 시 버튼 활성화
                    return;
                }

                // --- 서버로 이미지 데이터 전송 ---
                const formData = new FormData();
                const currentOverallRound = totalCompletedRounds + currentRoundInSet; 
                
                console.log("Submitting round_number:", currentOverallRound);
                // Blob 형태로 직접 전송
                formData.append('image_data', blob, `round_${currentOverallRound}_${teacher}.jpg`); 
                formData.append('round_number', currentOverallRound); 
                formData.append('teacher_id', teacher); 

                try {
                    const response = await fetch('/submit_au_data_with_image', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (response.ok) { 
                        console.log('Firebase 저장 성공:', result.message || '메시지 없음', '사진 URL:', result.photo_url, '스코어:', result.predicted_score, '라운드:', currentOverallRound); 
                        
                        // 라운드 진행 로직
                        currentRoundInSet++; 
                        if (currentRoundInSet > TOTAL_ROUNDS_PER_SET) { 
                            if (currentSet < TOTAL_SETS) { 
                                submitBtn.textContent = '다음 세트 안내';
                                submitBtn.style.backgroundColor = '#007bff';
                                submitBtn.style.boxShadow = '0 4px 10px rgba(0, 123, 255, 0.5)';
                                submitBtn.style.color = 'white';
                                submitBtn.onclick = () => {
                                    document.body.classList.remove('loaded');
                                    document.body.classList.add('fade-out');
                                    setTimeout(() => {
                                        window.location.href = "{{ url_for('next_set_guidance') }}?teacher_id=" + teacher + "&current_set=" + (currentSet + 1); 
                                    }, 400);
                                };
                            } else { 
                                submitBtn.textContent = '운동 완료';
                                submitBtn.style.backgroundColor = '#8e24aa';
                                submitBtn.style.boxShadow = '0 4px 10px rgba(142, 36, 170, 0.4)';
                                submitBtn.style.color = 'white';
                                submitBtn.onclick = () => {
                                    document.body.classList.remove('loaded');
                                    document.body.classList.add('fade-out');
                                    setTimeout(() => {
                                        window.location.href = "{{ url_for('feedback') }}?teacher_id=" + teacher; 
                                    }, 400);
                                };
                            }
                        } else { 
                            updateDisplay(); 
                        }
                    } else { 
                        console.error('서버 응답 오류:', result.message);
                        alert(`데이터 저장 실패: ${result.message}`);
                    }
                } catch (error) {
                    console.error("네트워크 또는 서버 오류:", error);
                    alert(`데이터 전송 중 오류 발생: ${error.message}`);
                } finally {
                    submitBtn.disabled = false; 
                }
            }, 'image/jpeg', 0.8); 
        };

        // 초기 로드 시
        window.addEventListener('DOMContentLoaded', () => {
            document.body.classList.add('loaded');
            updateDisplay();
            startWebcam(); 
            // 가이드 타원은 웹캠이 시작되고 비디오 엘리먼트의 크기가 확정된 후에 그리는 것이 더 안정적일 수 있습니다.
            // setInterval(drawEllipse, 100);을 여기에 추가하는 것을 고려해 보세요.
        });

        // delayedNav 함수는 홈 버튼 등에서 사용되므로 그대로 유지
        function delayedNav(url) {
            document.body.classList.remove('loaded');
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = url;
            }, 400);
        }
    </script>

</body>
</html>