<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>복합운동 피드백 | SMILE FIT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=SUIT:wght@400;600&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            opacity: 0;
            transition: opacity 0.4s ease;
            margin: 0;
            padding: 0;
            font-family: 'SUIT', sans-serif;
            background: #f8f9fa;
            color: #333;
            text-align: center; /* 전체 페이지 중앙 정렬 */
        }
        body.loaded {
            opacity: 1;
        }
        header {
            height: 14vh;
            background: linear-gradient(90deg, #69b7ff, #a17fff);
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .home-button {
            position: fixed;
            top: 10px;
            left: 16px;
            background: #ff4081;
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            border-radius: 6px;
            box-shadow: 0 0 8px #ff4081;
            z-index: 999;
            text-decoration: none;
            font-size: 14px;
        }
        .container {
            padding: 24px;
            text-align: center;
            max-width: 100vw;
            overflow-x: hidden;
        }
        .main-message {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #analyze-btn {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }
        #report {
            display: none; /* 초기에는 숨김 */
            border-top: 3px solid #aaa;
            padding-top: 24px;
        }
        .report-section {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .image-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            padding-bottom: 10px;
        }
        .image-row img {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #999;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 24px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
        }
        .section-title2 {
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 18px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
        }
        h4 {
            font-size: 18px;
        }
        .row-box {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 5vw;
            margin: 2vh 0;
            flex-wrap: wrap;
            max-width: 100vw;
        }
        .feedback-box {
            flex: 1 1 40%;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid #ccc;
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            max-width: 500px;
            margin-bottom: 20px;
        }
        .name-input-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 40px;
        }
        .name-input-row label {
            font-size: 16px;
            font-weight: bold;
        }
        .name-input-row input {
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 160px;
        }
        /* 파이차트 데이터 없을 때 메시지 표시를 위해 */
        #pie-chart-container div p, #similarity-chart-container p {
            margin-top: 20px;
            color: #888;
        }

        /* ▼▼▼▼▼ [추가된 부분] AU 분석 모드 상세 결과 카드 스타일 (feedback.html에서 가져옴) ▼▼▼▼▼ */
        .round-results-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            padding: 20px;
        }
        .round-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            width: 380px;
            text-align: left;
            display: flex;
            flex-direction: column;
        }
        .round-card h3 {
            font-size: 20px;
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #a17fff;
            padding-bottom: 5px;
        }
        .round-card p {
            font-size: 15px;
            margin: 5px 0;
            color: #555;
        }
        .round-card strong.score-good { color: #388e3c; }
        .round-card strong.score-ok { color: #ff9800; }
        .round-card strong.score-bad { color: #f44336; }
        .round-card img {
            width: 80%; /* 이미지 크기 조절 */
            max-width: 250px; /* 이미지 최대 너비 제한 */
            height: auto;
            border-radius: 8px;
            margin: 10px auto; /* 중앙 정렬 및 상하 마진 */
            border: 1px solid #ddd;
            flex-shrink: 0;
            display: block;
        }
        .gemini-feedback-box {
            background-color: #e0f2f7;
            border-left: 5px solid #03a9f4;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            color: #01579b;
            line-height: 1.6;
        }
        .toggle-au-details-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            margin-top: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .toggle-au-details-btn:hover {
            background-color: #5a6268;
        }
        .au-details-collapsible {
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease-out;
            border-top: 1px dashed #eee;
            margin-top: 10px;
        }
        .au-details-collapsible.expanded {
            height: auto;
            max-height: 300px;
            overflow-y: auto;
            padding-top: 8px;
        }
        .au-details { padding: 5px 0; }
        .au-details h4 { color: #6a1b9a; margin-bottom: 5px; }
        .au-details p { margin: 2px 0; font-size: 13px; word-wrap: break-word; }
        .au-compare-details { font-size: 14px; margin-top: 5px; font-weight: bold; }
        .au-compare-details.good { color: #388e3c; }
        .au-compare-details.ok { color: #ff9800; }
        .au-compare-details.bad { color: #f44336; }
        /* Chart.js 캔버스 스타일 */
        .au-chart-container {
            position: relative;
            width: 100%;
            height: 280px; /* 차트 높이 조절 */
            margin-top: 15px;
        }
        .au-chart-container canvas {
            max-width: 100%;
            height: 100% !important; /* Chart.js가 자동으로 설정하는 높이 무시 */
        }
        /* ▲▲▲▲▲ [추가된 부분] 여기까지 ▲▲▲▲▲ */

        /* 미디어 쿼리 (데스크탑/태블릿 최적화) */
        @media screen and (min-width: 1024px), (hover: hover) and (pointer: fine) {
            header { height: 100px; font-size: 28px; }
            .home-button { top: 24px; left: 24px; padding: 8px 16px; font-size: 20px; }
            .image-row img { width: 80px; height: 100px; }
            .row-box { gap: 2vw; margin: 2vh auto; max-width: 70vw; }
            .report-section { max-width: 70vw; margin: 20px auto; }
            .feedback-box { flex: 1 1 0; min-width: 200px; max-width: 34vw; margin-bottom: 20px; }
            /* ▼▼▼▼▼ [추가된 부분] AU 분석 모드 상세 결과 카드 미디어 쿼리 ▼▼▼▼▼ */
            .round-card { width: 420px; max-width: 420px; } /* 데스크탑에서 라운드 카드 너비 조정 */
            /* ▲▲▲▲▲ [추가된 부분] 여기까지 ▲▲▲▲▲ */
        }
    </style>
</head>
<body>
    <a class="home-button" href="/">홈으로</a>
    <header>SMILE FIT</header>

    <div class="container">
        <div class="main-message">운동을 완료했습니다!</div>
        <div class="name-input-row">
            <label for="user-name">이름을 입력하세요:</label>
            <input type="text" id="user-name" placeholder="홍길동" />
        </div>
        <button id="analyze-btn">운동 분석하기</button>

        <div id="report">
            <div class="report-section">
                <div class="section-title">SMILE FIT 결과 보고서 (<span id="report-mode-name"></span>) - <span id="report-date"></span></div>
            </div>

            <div class="report-section">
                <div class="section-title2" id="reference-images-title">기준 사진 (10장)</div>
                <div id="reference-images" class="image-row"></div>
            </div>

            <div class="report-section" id="user-images-section">
                <div class="section-title2" id="user-images-title">사용자 사진 (10장)</div>
                <div id="user-images" class="image-row"></div>
            </div>

            <div class="row-box">
                <div class="feedback-box" id="pie-chart-container">
                    <h4>가장 많이 사용된 근육 TOP 5</h4>
                    <div style="display: flex; justify-content: center; align-items: center; margin-top: 30px; padding: 0; max-height: 180px;">
                        <canvas id="topMusclePieChart" style="max-width: 180px;"></canvas>
                        <ul id="pie-labels" style="margin-left: 40px; list-style: none; padding: 0; text-align: left;"></ul>
                    </div>
                </div>
                <div class="feedback-box">
                    <h4>오늘 사용한 근육 & 동작 리스트</h4>
                    <ul id="top-expression-list" style="list-style: none; padding: 0; margin: 0; text-align: left;"></ul>
                </div>
            </div>
            
            <div class="row-box">
                <div class="feedback-box" id="similarity-chart-container">
                    <h4 id="similarity-chart-title">라운드별 유사도</h4>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="chart"></canvas>
                    </div>
                </div>
                <div class="feedback-box">
                    <h4>종합 피드백</h4>
                    <div id="summary-text" style="white-space: pre-line; line-height: 24px; text-align: left;">분석 결과 요약이 여기에 표시됩니다.</div>
                </div>
            </div>
            
            <div class="report-section" id="au-round-details-section">
                <div class="section-title2">AU 라운드별 상세 분석</div>
                <div id="au-round-details-container" class="round-results-container">
                    </div>
            </div>
            </div>
    </div>
    
    <script>
        // --- AU 코드별 이름 매핑 ---
        const AU_NAMES = {
            "AU01": "눈썹 안쪽 올리기", "AU02": "바깥 눈썹 올리기", "AU04": "눈썹 내리기", "AU05": "눈꺼풀 올리기",
            "AU06": "뺨 올리기", "AU07": "눈꺼풀 조이기", "AU09": "코 찡그리기", "AU10": "윗입술 올리기",
            "AU11": "입술 깊이 패기", "AU12": "입꼬리 올리기", "AU14": "딤플러", "AU15": "입꼬리 내리기",
            "AU17": "턱 당기기", "AU20": "입술 늘리기", "AU23": "입술 조이기", "AU24": "입술 누르기",
            "AU25": "입술 벌리기", "AU26": "턱 내리기", "AU28": "입술 빨기", "AU43": "눈 감기",
            "AU01_w": "눈썹 안쪽 올리기 (가중)", "AU02_w": "바깥 눈썹 올리기 (가중)", "AU04_w": "눈썹 내리기 (가중)", "AU05_w": "눈꺼풀 올리기 (가중)",
            "AU06_w": "뺨 올리기 (가중)", "AU07_w": "눈꺼풀 조이기 (가중)", "AU09_w": "코 찡그리기 (가중)", "AU10_w": "윗입술 올리기 (가중)",
            "AU11_w": "입술 깊이 패기 (가중)", "AU12_w": "입꼬리 올리기 (가중)", "AU14_w": "딤플러 (가중)", "AU15_w": "입꼬리 내리기 (가중)",
            "AU17_w": "턱 당기기 (가중)", "AU20_w": "입술 늘리기 (가중)", "AU23_w": "입술 조이기 (가중)", "AU24_w": "입술 누르기 (가중)",
            "AU25_w": "입술 벌리기 (가중)", "AU26_w": "턱 내리기 (가중)", "AU28_w": "입술 빨기 (가중)", "AU43_w": "눈 감기 (가중)"
        };
        // --- AU 코드별 이름 매핑 끝 ---

        const analyzeBtn = document.getElementById('analyze-btn');
        const reportDiv = document.getElementById('report');
        const userNameInput = document.getElementById('user-name');
        const reportDateSpan = document.getElementById('report-date');
        const reportModeNameSpan = document.getElementById('report-mode-name');
        const referenceImagesDiv = document.getElementById('reference-images');
        const userImagesDiv = document.getElementById('user-images');
        const userImagesSection = document.getElementById('user-images-section');
        const similarityChartTitle = document.getElementById('similarity-chart-title');
        const summaryTextDiv = document.getElementById('summary-text');
        const topExpressionList = document.getElementById('top-expression-list');
        const pieChartContainer = document.getElementById('pie-chart-container');
        const similarityChartContainer = document.getElementById('similarity-chart-container');
        const auRoundDetailsSection = document.getElementById('au-round-details-section');
        const auRoundDetailsContainer = document.getElementById('au-round-details-container');

        let teacherId = null; 
        const urlParams = new URLSearchParams(window.location.search);
        teacherId = urlParams.get('teacher_id');
        const currentSet = urlParams.get('current_set');

        let userOverallScores = []; 
        let userOverallAuFeatures = {}; 

        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.add('loaded');

            reportDateSpan.textContent = new Date().toLocaleDateString('ko-KR');
            reportModeNameSpan.textContent = "복합운동";

            if (teacherId) {
                fetchFeedbackData(teacherId);
            } else {
                summaryTextDiv.textContent = "선생님 정보가 없어 피드백을 표시할 수 없습니다.";
                console.error("Teacher ID is missing in URL parameters for complex_feedback.html");
                reportDiv.style.display = 'block';
            }

            analyzeBtn.addEventListener('click', () => {
                const userName = userNameInput.value.trim();
                if (userName) {
                    console.log(`Analyzing for user: ${userName}`);
                    reportDiv.style.display = 'block';
                } else {
                    alert("이름을 입력해주세요.");
                }
            });
        });

        async function fetchFeedbackData(teacherId) {
            try {
                const response = await fetch(`/get_user_feedback_data?teacher_id=${teacherId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '데이터를 불러오는 데 실패했습니다.');
                }
                const data = await response.json();
                console.log("Fetched feedback data:", data);

                renderFeedbackReport(data.user_data, data.teacher_references);

            } catch (error) {
                console.error("피드백 데이터 로드 중 오류:", error);
                summaryTextDiv.textContent = `피드백 로드 오류: ${error.message}`;
                reportDiv.style.display = 'block';
            }
        }

        function renderFeedbackReport(user_data, teacher_references) {
            referenceImagesDiv.innerHTML = '';
            teacher_references.forEach(item => {
                const img = document.createElement('img');
                img.src = item.image_path_static;
                img.alt = `${item.teacher_id} Round ${item.round_number}`;
                img.title = `${item.teacher_id} Round ${item.round_number}`;
                referenceImagesDiv.appendChild(img);
            });

            userImagesDiv.innerHTML = '';
            if (user_data.length > 0) {
                userImagesSection.style.display = 'block';
                user_data.forEach(item => {
                    const img = document.createElement('img');
                    img.src = item.photo_url || 'https://via.placeholder.com/60x80?text=No+Image';
                    img.alt = `User Round ${item.round_number}`;
                    img.title = `라운드 ${item.round_number} 점수: ${item.predicted_score ? item.predicted_score.toFixed(2) : 'N/A'}`;
                    userImagesDiv.appendChild(img);
                    userOverallScores.push(item.predicted_score || 0);

                    for (const auKey in item.au_features) {
                        if (item.au_features.hasOwnProperty(auKey)) {
                            userOverallAuFeatures[auKey] = (userOverallAuFeatures[auKey] || 0) + item.au_features[auKey];
                        }
                    }
                });
            } else {
                userImagesSection.style.display = 'none';
                userImagesDiv.innerHTML = '<p>아직 기록된 사용자 사진이 없습니다.</p>';
            }

            renderSimilarityChart(user_data);
            generateSummaryFeedback(user_data);
            renderTopMusclesChart(userOverallAuFeatures, user_data.length);
            renderTopExpressionList(userOverallAuFeatures);
            renderAuRoundDetails(user_data, teacher_references);
        }

        let similarityChart = null;
        function renderSimilarityChart(user_data) {
            const chartCanvas = document.getElementById('chart');
            if (!chartCanvas) {
                console.error("Similarity chart canvas not found.");
                return;
            }
            const ctx = chartCanvas.getContext('2d');

            if (user_data.length === 0) {
                similarityChartContainer.innerHTML = '<p>라운드별 유사도 데이터를 표시할 수 없습니다.</p>';
                return;
            }

            if (similarityChart) {
                similarityChart.destroy();
            }

            const labels = user_data.map(item => `라운드 ${item.round_number}`);
            const scores = user_data.map(item => item.predicted_score || 0);

            similarityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '유사도 점수',
                        data: scores,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 60,
                            max: 100,
                            title: {
                                display: true,
                                text: '점수'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '라운드'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '라운드별 유사도 점수 추이',
                            font: {
                                size: 18
                            }
                        }
                    }
                }
            });
        }

        // 종합 피드백 생성 함수 (수정된 로직)
        function generateSummaryFeedback(user_data) {
            if (user_data.length === 0) {
                summaryTextDiv.textContent = "아직 분석할 데이터가 없습니다. 운동을 시작해보세요!";
                return;
            }

            const avgScore = userOverallScores.reduce((a, b) => a + b, 0) / userOverallScores.length;

            let generalOverallComment = "";
            if (avgScore >= 90) {
                generalOverallComment = "전반적으로 아주 훌륭한 운동이었습니다! 표정 근육을 매우 잘 사용하고 계시네요.";
            } else if (avgScore >= 70) {
                generalOverallComment = "좋은 운동이었습니다! 몇몇 라운드에서 개선의 여지가 보입니다.";
            } else {
                generalOverallComment = "조금 더 연습이 필요해 보입니다. 각 라운드별 분석을 통해 자세를 교정하는 것이 중요합니다.";
            }

            let strengthAUs = {};
            let weaknessAUs = {};
            let hasActionableGeminiFeedback = false; // 최소 하나 이상의 유효한 Gemini 피드백이 있었는지 추적

            user_data.forEach(item => {
                if (item.gemini_feedback && item.gemini_feedback !== "피드백을 불러올 수 없습니다." &&
                    !item.gemini_feedback.includes("피드백 생성에 문제가 발생했습니다") &&
                    !item.gemini_feedback.includes("선생님 데이터가 부족하여")) {
                    
                    hasActionableGeminiFeedback = true;

                    const feedbackText = item.gemini_feedback.toLowerCase();

                    for (const auKey in AU_NAMES) {
                        if (feedbackText.includes(auKey.toLowerCase())) {
                            if (feedbackText.includes("매우 잘 일치") || feedbackText.includes("완벽") || feedbackText.includes("훌륭") || feedbackText.includes("아주 좋")) {
                                strengthAUs[auKey] = (strengthAUs[auKey] || 0) + 1;
                            }
                        }
                    }
                    for (const auKey in AU_NAMES) {
                        if (feedbackText.includes(auKey.toLowerCase())) {
                            if (feedbackText.includes("부족") || feedbackText.includes("차이가 있었") || feedbackText.includes("필요") || feedbackText.includes("덜 활성화")) {
                                weaknessAUs[auKey] = (weaknessAUs[auKey] || 0) + 1;
                            }
                        }
                    }
                }
            });

            let summaryFeedbackDetail = "";

            if (hasActionableGeminiFeedback) {
                const sortedStrengths = Object.entries(strengthAUs).sort((a, b) => b[1] - a[1]);
                if (sortedStrengths.length > 0) {
                    const topStrengths = sortedStrengths.slice(0, 3).map(([au, count]) => `**${au}** (${AU_NAMES[au] || ''})`).join(', ');
                    summaryFeedbackDetail += `<br>특히 **${topStrengths}** 부위에서 뛰어난 움직임을 보여주셨습니다!`;
                }

                const sortedWeaknesses = Object.entries(weaknessAUs).sort((a, b) => b[1] - a[1]);
                if (sortedWeaknesses.length > 0) {
                    const topWeaknesses = sortedWeaknesses.slice(0, 3).map(([au, count]) => `**${au}** (${AU_NAMES[au] || ''})`).join(', ');
                    summaryFeedbackDetail += `<br>하지만 **${topWeaknesses}** 부위는 좀 더 집중적인 연습이 필요해 보입니다.`;
                }

                if (sortedStrengths.length > 0 || sortedWeaknesses.length > 0) {
                    summaryFeedbackDetail += "<br><br>꾸준한 연습으로 더욱 자연스러운 표정을 만들어보세요!";
                } else {
                    summaryFeedbackDetail += "<br><br>전반적으로 훌륭하십니다! 다음 운동에서도 최선을 다해주세요.";
                }

            } else {
                summaryFeedbackDetail += "<br><br>AI 코칭을 위한 상세 피드백 데이터가 부족하거나 문제가 발생했습니다. 운동을 다시 시도해보세요!";
            }

            summaryTextDiv.innerHTML = `
                <strong>종합 요약:</strong><br>${generalOverallComment}
                ${summaryFeedbackDetail}
                <br><br>각 라운드별 상세 피드백과 그래프는 아래 'AU 라운드별 상세 분석' 섹션을 확인해 주세요.
            `;
        }

        let topMusclePieChart = null;
        function renderTopMusclesChart(au_features_sum, total_rounds) {
            const pieCanvas = document.getElementById('topMusclePieChart');
            if (!pieCanvas) {
                console.error("Top muscle pie chart canvas not found.");
                return;
            }
            const ctx = pieCanvas.getContext('2d');

            const allMuscles = Object.entries(au_features_sum)
                .filter(([key, value]) => !key.endsWith('_w') && value > 0)
                .map(([key, value]) => ({ au: key, avg_strength: value / total_rounds }));

            if (allMuscles.length === 0) {
                pieChartContainer.innerHTML = '<p>근육 데이터가 없어 파이차트를 표시할 수 없습니다.</p>';
                return;
            }

            allMuscles.sort((a, b) => b.avg_strength - a.avg_strength);
            const top5Muscles = allMuscles.slice(0, 5);

            const labels = top5Muscles.map(m => AU_NAMES[m.au] || m.au);
            const data = top5Muscles.map(m => m.avg_strength);
            const backgroundColors = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)'
            ];
            const borderColors = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ];

            if (topMusclePieChart) {
                topMusclePieChart.destroy();
            }

            topMusclePieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) { label += context.parsed.toFixed(2); }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            const pieLabelsList = document.getElementById('pie-labels');
            pieLabelsList.innerHTML = '';
            top5Muscles.forEach((muscle, index) => {
                const li = document.createElement('li');
                li.style.color = backgroundColors[index];
                li.innerHTML = `<strong>${muscle.au} (${AU_NAMES[muscle.au] || muscle.au})</strong>: ${muscle.avg_strength.toFixed(2)}`;
                pieLabelsList.appendChild(li);
            });
        }

        function renderTopExpressionList(au_features_sum) {
            const listElement = document.getElementById('top-expression-list');
            listElement.innerHTML = '';

            const activeAUs = Object.entries(au_features_sum)
                .filter(([key, value]) => !key.endsWith('_w') && value > 0.1)
                .map(([key, value]) => ({ au: key, total_strength: value }));

            activeAUs.sort((a, b) => b.total_strength - a.total_strength);

            if (activeAUs.length === 0) {
                listElement.innerHTML = '<li>분석할 활성 근육 데이터가 없습니다.</li>';
                return;
            }

            const topActiveAUs = activeAUs.slice(0, Math.min(activeAUs.length, 8));

            topActiveAUs.forEach(item => {
                const li = document.createElement('li');
                li.style.textAlign = 'left';
                const auName = AU_NAMES[item.au] ? ` (${AU_NAMES[item.au]})` : '';
                li.innerHTML = `<strong>${item.au}${auName}:</strong> 총 강도 ${item.total_strength.toFixed(2)}`;
                listElement.appendChild(li);
            });
        }

        function renderAuRoundDetails(user_data, teacher_references) {
            if (user_data.length === 0) {
                auRoundDetailsSection.style.display = 'none';
                return;
            }
            auRoundDetailsSection.style.display = 'block';
            auRoundDetailsContainer.innerHTML = '';

            user_data.forEach(roundData => {
                const roundNum = roundData.round_number;
                const userAuValues = roundData.au_features || {};
                const geminiFeedback = roundData.gemini_feedback || "Gemini 피드백을 불러올 수 없습니다.";

                let teacherAuValues = {};
                let teacherImagePath = '';

                const matchingTeacherData = teacher_references.find(tData =>
                    (tData.round_number !== undefined && tData.round_number !== null) &&
                    parseInt(tData.round_number) === parseInt(roundNum)
                );

                if (matchingTeacherData) {
                    teacherAuValues = matchingTeacherData.au_detail_values || {};
                    teacherImagePath = matchingTeacherData.image_path_static || '';
                }

                // 나의 AU 값 HTML
                const userAuDetailsHtml = Object.entries(userAuValues).map(([key, value]) => {
                    const auName = AU_NAMES[key] ? ` (${AU_NAMES[key]})` : '';
                    return `<p>${key}${auName}: ${value.toFixed(2)}</p>`;
                }).join('') || '<p>내 AU 정보 없음</p>';

                // 선생님 AU 값 HTML
                const teacherAuDetailsHtml = Object.entries(teacherAuValues).map(([key, value]) => {
                    const auName = AU_NAMES[key] ? ` (${AU_NAMES[key]})` : '';
                    return `<p>${key}${auName}: ${value.toFixed(2)}</p>`;
                }).join('') || '<p>선생님 AU 정보 없음</p>';

                // AU 비교 피드백 HTML
                const auComparisonHtml = [];
                const allAuKeysForComparison = Object.keys(userAuValues).sort();
                for (const auKey of allAuKeysForComparison) {
                    const userVal = userAuValues[auKey] || 0;
                    const teacherVal = teacherAuValues[auKey] || 0;
                    const epsilon = 1e-6;

                    let similarity = 0;
                    if (teacherVal > epsilon || userVal > epsilon) {
                        const difference = Math.abs(userVal - teacherVal);
                        const maxValue = Math.max(userVal, teacherVal);
                        if (maxValue > epsilon) { similarity = 1 - (difference / maxValue); } else { similarity = 1; }
                    } else { similarity = 1; }

                    const auSimilarityPercent = similarity * 100;
                    let comment = "";
                    let className = "";

                    if (auSimilarityPercent >= 85) { comment = "매우 잘 일치합니다!"; className = "good"; }
                    else if (auSimilarityPercent >= 60) { comment = "잘 일치하는 편입니다."; className = "ok"; }
                    else { comment = "조금 더 연습이 필요해요."; className = "bad"; }
                    const auDisplayName = AU_NAMES[auKey] ? ` (${AU_NAMES[auKey]})` : '';
                    auComparisonHtml.push(`
                        <p>${auKey}${auDisplayName}: 사용자 ${userVal.toFixed(2)}, 선생님 ${teacherVal.toFixed(2)}</p>
                        <p class="au-compare-details ${className}">${comment} (유사도: ${auSimilarityPercent.toFixed(1)}%)</p>
                    `);
                }

                const roundCardHtml = `
                    <div class="round-card">
                        <h3>라운드 ${roundNum}</h3>
                        <p>유사도 점수: <strong class="${getScoreClassName(roundData.predicted_score)}">${roundData.predicted_score ? roundData.predicted_score.toFixed(2) : 'N/A'}</strong></p>
                        ${roundData.photo_url && roundData.photo_url !== 'no_image_provided' ?
                            `<img src="${roundData.photo_url}" alt="라운드 ${roundNum} 사용자 사진">` :
                            '<p>캡처된 사진 없음</p>'}
                        ${teacherImagePath ? `<img src="${teacherImagePath}" alt="라운드 ${roundNum} 선생님 사진">` : ''}
                        
                        <div class="gemini-feedback-box">
                            <p><strong>Gemini AI 코칭:</strong></p>
                            <p>${geminiFeedback}</p>
                        </div>

                        <div class="au-chart-container">
                            <canvas id="auChart_Round${roundNum}"></canvas>
                        </div>

                        <button class="toggle-au-details-btn">AU 상세 분석 보기</button>
                        <div class="au-details-collapsible">
                            <div class="au-details">
                                <h4>나의 AU 값:</h4>
                                ${userAuDetailsHtml}
                            </div>
                            <div class="au-details" style="margin-top: 10px;">
                                <h4>선생님 AU 값:</h4>
                                ${teacherAuDetailsHtml}
                            </div>
                            <div class="au-details" style="margin-top: 15px;">
                                <h4>AU 비교 피드백:</h4>
                                ${auComparisonHtml.join('') || '<p>비교 데이터 없음</p>'}
                            </div>
                        </div>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = roundCardHtml.trim();
                const newRoundCardElement = tempDiv.firstChild;
                auRoundDetailsContainer.appendChild(newRoundCardElement);

                // Chart.js 그래프 그리기 (AU 분석 모드 전용)
                if (matchingTeacherData) {
                    const ctx = document.getElementById(`auChart_Round${roundNum}`).getContext('2d');
                    const selectedAuKeysForChart = [
                        "AU06", "AU01", "AU04", "AU07", "AU02", "AU05", "AU09", "AU14", "AU15", "AU17"
                    ].filter(key => userAuValues[key] !== undefined || teacherAuValues[key] !== undefined); 
                    selectedAuKeysForChart.sort();

                    const chartLabels = selectedAuKeysForChart;
                    const userDataForChart = selectedAuKeysForChart.map(key => userAuValues[key] || 0);
                    const teacherDataForChart = selectedAuKeysForChart.map(key => teacherAuValues[key] || 0);

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                { label: '내 AU 강도', data: userDataForChart, backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 },
                                { label: '선생님 AU 강도', data: teacherDataForChart, backgroundColor: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { title: { display: true, text: `라운드 ${roundNum} AU 강도 비교`, font: { size: 16 } }, legend: { position: 'top' },
                                tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += context.parsed.y.toFixed(2); } return label; } } }
                            },
                            scales: {
                                y: { beginAtZero: true, max: 1.2, title: { display: true, text: 'AU 강도' } },
                                x: { title: { display: true, text: 'Action Unit' }, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45, font: { size: 10 } } }
                            }
                        }
                    });
                } else {
                    const chartContainer = newRoundCardElement.querySelector(`.au-chart-container`);
                    if (chartContainer) {
                        chartContainer.innerHTML = '<p style="text-align: center; color: #777;">선생님 데이터가 없어 AU 강도를 비교할 수 없습니다.</p>';
                    }
                }

                // 토글 버튼 이벤트 리스너 연결
                const toggleButton = newRoundCardElement.querySelector('.toggle-au-details-btn');
                const collapsibleDiv = newRoundCardElement.querySelector('.au-details-collapsible');

                if (toggleButton && collapsibleDiv) {
                    toggleButton.addEventListener('click', () => {
                        if (collapsibleDiv.classList.contains('expanded')) {
                            collapsibleDiv.classList.remove('expanded');
                            collapsibleDiv.style.height = '0';
                            collapsibleDiv.style.paddingTop = '0';
                            toggleButton.textContent = 'AU 상세 분석 보기';
                        } else {
                            collapsibleDiv.style.height = 'auto';
                            const scrollHeight = collapsibleDiv.scrollHeight;
                            collapsibleDiv.style.height = scrollHeight + 'px';
                            collapsibleDiv.classList.add('expanded');
                            collapsibleDiv.style.paddingTop = '8px';
                            toggleButton.textContent = 'AU 상세 분석 숨기기';
                        }
                    });
                }
            });
        }

        function getScoreClassName(score) {
            if (score >= 80) return 'score-good';
            if (score >= 60) return 'score-ok';
            return 'score-bad';
        }

    </script>
</body>
</html>