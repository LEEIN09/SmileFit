<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="/manifest.json" />

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <title>í™ˆ | ì•ˆë©´ê·¼ìœ¡ ì¬í™œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=SUIT:wght@400;600&display=swap" rel="stylesheet">
 <style>
  body {
    margin: 0;
    padding: 0;
    height: 100dvh;
    font-family: 'SUIT', sans-serif;
    background-color: white;
    color: #333;
    display: flex;
    flex-direction: column;
    opacity: 0; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ (ìŠ¤í¬ë¦½íŠ¸ë¡œ loaded í´ë˜ìŠ¤ ì¶”ê°€ ì‹œ í‘œì‹œ) */
    transition: opacity 0.4s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
  }

  body.loaded {
    opacity: 1;
  }

  body.fade-out {
    opacity: 0;
  }

  header {
    height: 14vh;
    background: linear-gradient(90deg, #69b7ff, #a17fff);
    color: white;
    font-family: 'Orbitron', sans-serif;
    font-size: 22px;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  h2 {
    height: 8vh;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-bottom: 0;
    margin-top: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
    margin-bottom: 1vh; /* ë²„íŠ¼ ê·¸ë£¹ê³¼ì˜ ê°„ê²© ì¡°ì • */
  }

  .button-group {
    /* height: 72vh; */ /* ë‚´ìš©ì— ë”°ë¼ ìœ ë™ì ìœ¼ë¡œ ë³€ê²½ë˜ë„ë¡ height ì œê±° ë˜ëŠ” min-height ì‚¬ìš© ê³ ë ¤ */
    flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ì±„ìš°ë„ë¡ ì„¤ì • */
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ ê°œì„  */
    gap: 40px;
    /* margin-bottom: 6vh; */ /* bodyì— flex-direction: column ì´ë¯€ë¡œ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ */
    padding: 0 20px; /* ì¢Œìš° íŒ¨ë”© ì¶”ê°€ */
  }

  .mode-box {
    width: 40vw;
    max-width: 300px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
    height: auto; /* ë‚´ìš©ì— ë§ê²Œ ë†’ì´ ìë™ ì¡°ì ˆ */
    min-height: 50vh; /* ìµœì†Œ ë†’ì´ ì„¤ì • */
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    justify-content: space-around; /* ë‚´ë¶€ ìš”ì†Œ ê°„ê²© ê· ë“±í•˜ê²Œ */
    align-items: center;
    padding: 3vh 2vh; /* íŒ¨ë”© ì¡°ì • */
    box-sizing: border-box;
    gap: 2vh; /* ë‚´ë¶€ ìš”ì†Œ ê°„ ê°„ê²© */
  }

  .mode-box img {
    width: 80%; /* ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • */
    max-height: 50%; /* ì´ë¯¸ì§€ ìµœëŒ€ ë†’ì´ ì œí•œ */
    object-fit: contain; /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ containìœ¼ë¡œ ë³€ê²½ */
    display: block;
  }

  .mode-box button {
    width: 70%; /* ë²„íŠ¼ ë„ˆë¹„ ì¡°ì • */
    padding: 12px; /* ë²„íŠ¼ íŒ¨ë”© ì¦ê°€ */
    font-size: 16px;
    font-weight: bold;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease; /* í˜¸ë²„ íš¨ê³¼ */
  }

  .mode-box button:hover {
    filter: brightness(1.1);
  }

  .mode-left {
    background:
      linear-gradient(rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.5)),
      url('static/images/space.png');
    background-size: cover;
    background-position: center;
  }

  .mode-left button {
    background-color: rgba(138, 43, 226, 0.85);
  }

  .mode-right {
    background:
      linear-gradient(rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.5)),
      url('static/images/grass.png');
    background-size: cover;
    background-position: center;
  }

  .mode-right button {
    background-color: rgba(56, 142, 60, 0.9);
  }

  .home-button {
    position: fixed;
    top: 10px;
    left: 16px;
    background: #ff4081;
    color: white;
    padding: 4px 8px;
    font-weight: bold;
    border-radius: 6px;
    box-shadow: 0 0 8px #ff4081;
    z-index: 999;
    text-decoration: none;
    font-size: 14px;
  }

  /* ğŸ’» ë°ìŠ¤í¬íƒ‘ ëŒ€ì‘ */
  @media screen and (min-width: 768px) { /* ë°˜ì‘í˜• ê¸°ì¤€ì  ë³€ê²½ */
    header {
      height: 100px;
      font-size: 28px;
    }

    h2 {
      height: auto; /* ë‚´ìš©ì— ë§ê²Œ */
      padding: 20px 0; /* ìƒí•˜ íŒ¨ë”© */
      font-size: 26px;
      margin-bottom: 20px;
    }

    .button-group {
      gap: 60px; /* ë°ìŠ¤í¬íƒ‘ì—ì„œ ê°„ê²© ì¦ê°€ */
      align-items: flex-start; /* ìƒë‹¨ ì •ë ¬ */
    }

    .mode-box {
      width: 350px; /* ë„ˆë¹„ ê³ ì •ê°’ ì‚¬ìš© */
      min-height: 400px; /* ë°ìŠ¤í¬íƒ‘ ìµœì†Œ ë†’ì´ */
      padding: 30px;
      gap: 30px;
    }
    .mode-box img {
      width: 90%;
      max-height: 200px; /* ë°ìŠ¤í¬íƒ‘ ì´ë¯¸ì§€ ë†’ì´ ì œí•œ */
    }

    .mode-box button {
      font-size: 20px; /* ë²„íŠ¼ í°íŠ¸ í¬ê¸° ì¦ê°€ */
      padding: 15px;
      width: 60%;
    }

    .home-button {
      top: 24px;
      left: 24px;
      padding: 8px 16px;
      font-size: 20px;
    }
  }
</style>
</head>
<body>
  <audio id="metal_click" src="/static/sounds/metal_click.mp3" preload="auto"></audio>
  <audio id="click_sound" src="/static/sounds/click_sound.wav" preload="auto"></audio>

  <div id="app">
    </div>

  <a href="#" class="home-button" onclick="loadPage('index'); return false;">HOME</a>

  <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ ë° body loaded í´ë˜ìŠ¤ ì¶”ê°€
    window.addEventListener('DOMContentLoaded', () => {
      // ì´ˆê¸° í˜ì´ì§€ë¥¼ 'index'ë¡œ ì„¤ì • (ë˜ëŠ” ë‹¤ë¥¸ ê¸°ë³¸ í˜ì´ì§€)
      // loadPage í•¨ìˆ˜ê°€ ì •ì˜ëœ í›„ì— í˜¸ì¶œí•´ì•¼ í•˜ë¯€ë¡œ, ì•„ë˜ë¡œ ì˜®ê¸°ê±°ë‚˜ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ë¡œ ê°ìŒ€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      // ì—¬ê¸°ì„œëŠ” loadPage ì •ì˜ í›„ ë§ˆì§€ë§‰ì— í˜¸ì¶œí•˜ê² ìŠµë‹ˆë‹¤.
    });

    function metalClickSound() {
      const sound = document.getElementById('metal_click');
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.warn("ì†Œë¦¬ ì¬ìƒ ì˜¤ë¥˜(metal_click):", e));
      }
    }

    function ClickSound() {
      const sound = document.getElementById('click_sound');
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.warn("ì†Œë¦¬ ì¬ìƒ ì˜¤ë¥˜(click_sound):", e));
      }
    }

    // í˜ì´ì§€ ë¼ìš°íŒ… ì •ë³´
    const routes = {
      'index': '/pages/index.html', // í™ˆí˜ì´ì§€ ì½˜í…ì¸ 
      'game_follow': '/pages/game_follow.html',
      'game_mode': '/pages/game_mode.html',
      'game_emotion': '/pages/game_emotion.html',
      'rehab_mode': '/pages/rehab_mode.html',
      'complex': '/pages/complex.html', // ì„ ìƒë‹˜ ì„ íƒ í˜ì´ì§€
      'complex_fit': '/pages/complex_fit.html', // ë³µí•© ìš´ë™ í˜ì´ì§€
      'focus': '/pages/focus.html',
      'focus_fit': '/pages/focus_fit.html',
      'complex_feedback': '/pages/complex_feedback.html', // ë³µí•© ìš´ë™ í”¼ë“œë°±
      'focus_feedback': '/pages/focus_feedback.html',
      'next_set_guidance': '/pages/next_set_guidance.html', // AU ëª¨ë“œ ì„¸íŠ¸ ì¤‘ê°„ ì•ˆë‚´
      'face_emotion': '/tower_defense_game.html?mode=emotion_expression',
      'face_follow': '/tower_defense_game.html?mode=follow_expression'
    };

    let currentModule = null; // í˜„ì¬ ë¡œë“œëœ í˜ì´ì§€ì˜ JS ëª¨ë“ˆ ì°¸ì¡°
    const pageCache = new Map(); // HTML ì½˜í…ì¸  ìºì‹œ

    async function loadPage(routeKey) {
      const path = routes[routeKey];
      if (!path) {
        console.error(`ë¼ìš°íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${routeKey}`);
        return;
      }

      // --- ë¡œê¹… ì¶”ê°€ ---
      console.log(`[loadPage START ${routeKey}] Page load initiated at ${new Date().toISOString()}`);
      console.time(`[loadPage DURATION ${routeKey}]`); // ì „ì²´ ë¡œë“œ ì‹œê°„ ì¸¡ì • ì‹œì‘

      // ì´ì „ ëª¨ë“ˆì˜ cleanup í•¨ìˆ˜ í˜¸ì¶œ (ì¡´ì¬í•œë‹¤ë©´)
      if (currentModule && typeof currentModule.cleanup === 'function') {
        try {
          // --- ë¡œê¹… ì¶”ê°€ ---
          console.log(`[loadPage ${routeKey}] Previous module (${currentModule.routeName || 'unknown'}) cleanup function calling at ${new Date().toISOString()}`);
          currentModule.cleanup();
          console.log(`[loadPage ${routeKey}] Previous module cleanup completed at ${new Date().toISOString()}`);
        } catch (e) {
          console.error(`[loadPage ${routeKey}] Error during previous module cleanup:`, e);
        }
      }
      currentModule = null; // ì´ì „ ëª¨ë“ˆ ì°¸ì¡° ì œê±°

      // í˜ì´ì§€ ì „í™˜ ì‹œê° íš¨ê³¼
      document.body.classList.remove('loaded');
      document.body.classList.add('fade-out');
      // --- ë¡œê¹… ì¶”ê°€ ---
      console.log(`[loadPage ${routeKey}] Body fade-out initiated at ${new Date().toISOString()}`);


      // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(400ms) í›„ HTML ë¡œë“œ ë° ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™”
      setTimeout(async () => {
        // --- ë¡œê¹… ì¶”ê°€ ---
        console.log(`[loadPage ${routeKey}] setTimeout callback fired (after 400ms animation) at ${new Date().toISOString()}`);
        try {
          let htmlContent;
          // --- ë¡œê¹… ì¶”ê°€ ---
          console.time(`[loadPage HTML_FETCH ${routeKey}]`);
          if (pageCache.has(routeKey)) {
            htmlContent = pageCache.get(routeKey);
            console.log(`[loadPage ${routeKey}] HTML loaded from cache at ${new Date().toISOString()}`);
          } else {
            console.log(`[loadPage ${routeKey}] Fetching HTML from server: ${path} at ${new Date().toISOString()}`);
            const response = await fetch(path);
            if (!response.ok) {
              throw new Error(`HTTP ì˜¤ë¥˜ ${response.status}: ${path} íŒŒì¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            }
            htmlContent = await response.text();
            pageCache.set(routeKey, htmlContent);
            console.log(`[loadPage ${routeKey}] HTML fetched from server and cached at ${new Date().toISOString()}`);
          }
          console.timeEnd(`[loadPage HTML_FETCH ${routeKey}]`);

          const appContainer = document.getElementById('app');
          if (!appContainer) {
            console.error(`[loadPage ${routeKey}] CRITICAL: 'app' container element not found! at ${new Date().toISOString()}`);
            document.body.classList.remove('fade-out');
            document.body.classList.add('loaded');
            return;
          }
          // --- ë¡œê¹… ì¶”ê°€ ---
          console.log(`[loadPage ${routeKey}] Setting appContainer.innerHTML at ${new Date().toISOString()}`);
          appContainer.innerHTML = htmlContent; // ìƒˆ HTML ì½˜í…ì¸  ì‚½ì…
          console.log(`[loadPage ${routeKey}] appContainer.innerHTML set. DOM update process should be starting at ${new Date().toISOString()}`);


          if (!routeKey.startsWith("face_")) {
            try {
              const version = new Date().getTime();
              const modulePath = `/scripts/${routeKey}.js?v=${version}`;
              // --- ë¡œê¹… ì¶”ê°€ ---
              console.log(`[loadPage ${routeKey}] Attempting to import module: ${modulePath} at ${new Date().toISOString()}`);
              console.time(`[loadPage MODULE_IMPORT ${routeKey}]`);
              const module = await import(modulePath);
              console.timeEnd(`[loadPage MODULE_IMPORT ${routeKey}]`);
              console.log(`[loadPage ${routeKey}] Module imported: ${modulePath} at ${new Date().toISOString()}`, module);

              currentModule = module;
              currentModule.routeName = routeKey;

              if (module && typeof module.init === 'function') {
                // --- ë¡œê¹… ì¶”ê°€ ---
                console.log(`[loadPage ${routeKey}] Module has init function. Scheduling with requestAnimationFrame at ${new Date().toISOString()}`);
                requestAnimationFrame(() => {
                  try {
                    // --- ë¡œê¹… ì¶”ê°€ ---
                    console.log(`[loadPage ${routeKey} - rAF] requestAnimationFrame callback fired for init() at ${new Date().toISOString()}`);
                    console.time(`[loadPage INIT_EXECUTION ${routeKey}]`);
                    module.init();
                    console.timeEnd(`[loadPage INIT_EXECUTION ${routeKey}]`);
                    console.log(`[loadPage ${routeKey} - rAF] module.init() execution finished at ${new Date().toISOString()}`);
                  } catch (e) {
                    console.error(`[loadPage ${routeKey} - rAF] Error during module.init() execution:`, e);
                  }
                });
              } else {
                console.warn(`[loadPage ${routeKey}] âš ï¸ Module or its init function is problematic or missing at ${new Date().toISOString()}`);
              }
            } catch (e) {
              console.warn(`[loadPage ${routeKey}] âš ï¸ Failed to load or execute module ${routeKey}.js:`, e, `at ${new Date().toISOString()}`);
            }
          } else {
            console.log(`[loadPage ${routeKey}] Route starts with "face_", skipping JS module load. at ${new Date().toISOString()}`);
          }

          document.body.classList.remove('fade-out');
          document.body.classList.add('loaded');
          // --- ë¡œê¹… ì¶”ê°€ ---
          console.log(`[loadPage ${routeKey}] Body fade-in completed at ${new Date().toISOString()}`);

        } catch (error) {
          console.error(`[loadPage ${routeKey}] âŒ CRITICAL error during page loading or initialization:`, error, `at ${new Date().toISOString()}`);
          document.body.classList.remove('fade-out');
          document.body.classList.add('loaded');
          const appContainer = document.getElementById('app');
          if (appContainer) {
            appContainer.innerHTML = `<p style="color:red; text-align:center; padding:20px;">í˜ì´ì§€ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`;
          }
        } finally {
          // --- ë¡œê¹… ì¶”ê°€ ---
          console.timeEnd(`[loadPage DURATION ${routeKey}]`); // ì „ì²´ ë¡œë“œ ì‹œê°„ ì¸¡ì • ì¢…ë£Œ
          console.log(`[loadPage END ${routeKey}] Page load process finished at ${new Date().toISOString()}`);
        }
      }, 400);
    }

    // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/serviceWorker.js")
          .then(() => console.log("âœ… Service Worker registered"))
          .catch((err) => console.error("âŒ Service Worker registration failed:", err));
      });
    }

    // DOMContentLoaded í›„ ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ
    window.addEventListener('DOMContentLoaded', () => {
      console.log(`[DOMContentLoaded] Event fired at ${new Date().toISOString()}`);
      loadPage('index');
    });
  </script>
</body>
</html>